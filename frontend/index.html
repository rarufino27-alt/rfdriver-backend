<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard - RF Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<link rel="stylesheet" href="css-theme.css">
</head>

<body>

<!-- CONTROLES GLOBAIS -->
<div class="drawer-toggle" onclick="toggleDrawer()">
  <i class="fa fa-bars"></i>
</div>

<div class="theme-toggle" onclick="toggleTheme()">
  <i class="fa fa-moon"></i>
</div>

<!-- MENU LATERAL -->
<div id="menu-lateral"></div>

<!-- CONTEÚDO -->
<main id="conteudo" style="padding:80px 16px 150px">

  <h1 style="color:var(--gold)">Dashboard</h1>

  <div class="card">
    <div>Lucro do Dia</div>
    <div id="lucroValor">R$ 0,00</div>
  </div>

  <div class="card">
    <div>Meta do Dia</div>
    <div class="progress">
      <div class="progress-bar" id="metaBar"></div>
    </div>
  </div>

  <div class="card">
    <div>Faturado</div>
    <div id="fat" style="color:var(--green)">R$ 0,00</div>
  </div>

  <div class="card">
    <div>Gastos</div>
    <div id="gastos" style="color:var(--red)">R$ 0,00</div>
  </div>

  <div class="card">
    <h3>Próximas Viagens</h3>
    <table>
      <tbody id="listaAgendamentos"></tbody>
    </table>
  </div>

</main>

<!-- MENU INFERIOR -->
<div id="menu-inferior"></div>

<!-- SCRIPTS GLOBAIS -->
<script src="js-dataManager.js"></script>
<script src="js-global.js"></script>
<script src="js-planoManager.js"></script>
<script>
  PlanoManager.protegerPagina("dashboard");
</script>

<script>
loadComponent("menu-lateral","components-menu-lateral.html");
loadComponent("menu-inferior","components-menu-inferior.html");
</script>

<script>
/* ===== DASHBOARD ===== */
function atualizarDashboard(){

  const caixa = JSON.parse(localStorage.getItem("rf_caixa")) || {
    entradas: [],
    saidas: []
  };

  const entradas = caixa.entradas.reduce((s,i)=>s + Number(i.valor||0),0);
  const saidas   = caixa.saidas.reduce((s,i)=>s + Number(i.valor||0),0);
  const lucro    = entradas - saidas;

  lucroValor.textContent = lucro.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  fat.textContent        = entradas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  gastos.textContent     = saidas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

  const meta = Number(localStorage.getItem("rf_meta_diaria")) || 250;
  metaBar.style.width = Math.min((entradas/meta)*100,100)+"%";

  const data = DataManager.get("agendamentos",[]);
  const hoje = new Date().toISOString().slice(0,10);

  const ags = data
    .filter(a=>a.data>=hoje)
    .sort((a,b)=>`${a.data} ${a.hora}`.localeCompare(`${b.data} ${b.hora}`))
    .slice(0,5);

  listaAgendamentos.innerHTML = ags.length
    ? ags.map(a=>`
      <tr>
        <td>
          <strong>${a.data.split("-").reverse().join("/")}</strong> ${a.hora}<br>
          ${a.origem} → ${a.destino}<br>
          <span class="badge">${a.tipo}</span>
        </td>
        <td>
          ${Number(a.valor||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
        </td>
      </tr>
    `).join("")
    : "<tr><td>Nenhuma viagem agendada</td></tr>";
}

atualizarDashboard();
setInterval(atualizarDashboard, 3000);
</script>

</body>
</html>
