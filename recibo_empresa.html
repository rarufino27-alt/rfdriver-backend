<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recibo Corporativo - Fluxo Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<!-- jsPDF para gerar o PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --gold-dark:#d6b25f;
  --gold-dark2:#e8d08a;

  --gold-light:#90731b;
  --gold-light2:#b08c2e;

  --bg-dark:#0d0d0d;
  --text-dark:#f4f4f4;
  --card-dark:#161616;
  --border-dark:#242424;

  --bg-light:#f7f7f7;
  --text-light:#222;
  --card-light:#ffffff;
  --border-light:#d6d6d6;

  --radius:14px;
}

body.dark{
  --bg:var(--bg-dark);
  --text:var(--text-dark);
  --card:var(--card-dark);
  --border:var(--border-dark);
  --gold-main:var(--gold-dark);
  --gold-main2:var(--gold-dark2);
}
body.light{
  --bg:var(--bg-light);
  --text:var(--text-light);
  --card:var(--card-light);
  --border:var(--border-light);
  --gold-main:var(--gold-light);
  --gold-main2:var(--gold-light2);
}

*{ box-sizing:border-box; font-family:Inter,system-ui; }

body{
  margin:0; background:var(--bg); color:var(--text);
  padding-top:70px; padding-bottom:100px;
}

/* Drawer */
.drawer{
  position:fixed; top:0; left:-260px;
  width:260px; height:100%;
  background:var(--card); transition:.3s;
  z-index:9999; padding-top:70px;
}
.drawer.open{ left:0; }
.drawer a{
  display:block; padding:14px 22px;
  border-bottom:1px solid var(--border);
  text-decoration:none; color:var(--text);
}

.drawer-toggle{
  position:fixed; left:15px; top:15px; z-index:10000;
  background:var(--gold-main);
  padding:7px 12px; border-radius:10px; color:#000;
  font-size:23px; cursor:pointer;
}

/* theme */
.theme-toggle{
  position:fixed; right:15px; top:15px; z-index:10001;
  background:var(--card); padding:6px 10px; border-radius:10px;
  font-size:22px; cursor:pointer;
}

/* header */
.page-header{
  padding:0 20px 10px;
}
h1{ margin:0; font-size:30px; font-weight:800; color:var(--gold-main);}

/* tabs */
.tabs{display:flex; gap:10px; margin-top:12px;}
.tab-btn{
  flex:1; background:var(--card); border:1px solid var(--border);
  padding:10px; border-radius:999px; cursor:pointer;
  font-weight:700; color:var(--text); text-align:center;
}
.tab-btn.active{
  background:linear-gradient(90deg,var(--gold-main),var(--gold-main2));
  border:none; color:#000;
}

/* container */
.container{padding:0 20px 20px;}

/* card */
.card{
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius); padding:18px; margin-top:16px;
}
.card h3{margin-top:0;margin-bottom:10px;}

label{display:block;margin-top:10px; font-size:13px;}
input,select,textarea{
  width:100%; margin-top:6px; padding:11px; border-radius:10px;
  border:1px solid var(--border); background:var(--card); color:var(--text);
}
textarea{resize:vertical; min-height:80px;}
.row{display:flex; flex-wrap:wrap; gap:12px;}
.col{flex:1; min-width:120px;}

button{
  padding:12px; border:none; border-radius:10px;
  background:linear-gradient(90deg,var(--gold-main),var(--gold-main2));
  cursor:pointer; font-weight:700; color:#000; margin-top:12px;
}

/* funcionarios */
.funcionario-block{
  background:var(--card); border:1px solid var(--border);
  border-radius:12px; padding:12px; margin-bottom:12px;
}

/* tabbar */
.tabbar{
  position:fixed; bottom:0; left:0; right:0; height:70px;
  background:var(--card); border-top:1px solid var(--border);
  display:flex; justify-content:space-around; align-items:center;
  z-index:9990;
}
.tabbar a{
  text-decoration:none; color:var(--text);
  font-size:20px; text-align:center;
}
.tabbar small{display:block; font-size:12px;}
.action-btn{
  width:58px; height:58px; border-radius:50%;
  background:linear-gradient(90deg,var(--gold-main),var(--gold-main2));
  border:none; font-size:26px; margin-top:-35px; color:#000;
}
</style>
</head>

<body class="light">

<div class="drawer-toggle" onclick="toggleDrawer()">‚ò∞</div>
<div id="toggleTheme" class="theme-toggle" onclick="toggleTheme()">üåì</div>

<nav class="drawer" id="drawer">
  <a href="index.html">üè† Dashboard</a>
  <a href="entradas.html">üíµ Caixa</a>
  <a href="resumo.html">üìä Resumo</a>
  <a href="calculadora.html">üìü Calculadora</a>
  <a href="planos.html">üíé Planos</a>
  <a href="perfil.html">üë§ Perfil</a>
  <a href="recibo_empresa.html">üè≠ Empresas</a>
  <a href="recibo_particular.html">üöò Particular</a>
  <a href="manutencao.html">üõ† Manuten√ß√£o</a>
</nav>

<div class="page-header">
  <h1>Recibo Corporativo</h1>
  <div class="tabs">
    <div id="tabCadastro" data-tab="cadastro" class="tab-btn active">Cadastro</div>
    <div id="tabEmitir" data-tab="emitir" class="tab-btn">Emitir</div>
    <div id="tabHistorico" data-tab="historico" class="tab-btn">Hist√≥rico</div>
  </div>
</div>

<div class="container">
  <!-- ======================
       ABA CADASTRO
  ========================= -->
  <section id="abaCadastro" class="card">
    <h3>Dados do motorista / empresa</h3>

    <div class="row">
      <div class="col">
        <label>Empresa (opcional)</label>
        <input id="empresa" type="text">
      </div>
      <div class="col">
        <label>CNPJ (opcional)</label>
        <input id="cnpj" type="text">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Motorista *</label>
        <input id="motorista" type="text">
      </div>
      <div class="col">
        <label>CPF ou RG *</label>
        <input id="cpf" type="text">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Marca *</label>
        <input id="marca" type="text">
      </div>
      <div class="col">
        <label>Modelo *</label>
        <input id="modelo" type="text">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Placa *</label>
        <input id="placa" type="text">
      </div>
      <div class="col">
        <label>Cor *</label>
        <input id="cor" type="text">
      </div>
    </div>

    <button id="btnSalvarCadastro">Salvar Dados</button>
  </section>


  <!-- ======================
       ABA EMITIR
  ========================= -->
  <section id="abaEmitir" class="card" style="display:none;">
    <h3>Dados da viagem</h3>

    <label>Empresa destino *</label>
    <input id="empresaDestino" type="text">

    <label>Empresa respons√°vel</label>
    <input id="empresaResponsavel" type="text">

    <label>Solicitante</label>
    <input id="solicitante" type="text">

    <label>Hor√°rio de chegada</label>
    <input id="horaChegada" type="time">

    <label>Descri√ß√£o da viagem</label>
    <textarea id="descricao"></textarea>

    <h3>Funcion√°rios</h3>
    <div id="funcionariosContainer"></div>

    <div style="display:flex;gap:10px;">
      <button type="button" id="btnAddFuncionario">+ Adicionar</button>
      <button type="button" id="btnRemoveFuncionario" style="background:#aaa;">- Remover</button>
    </div>

    <h3 style="margin-top:15px;">Hor√°rios / KM</h3>

    <label>Hor√°rio in√≠cio</label>
    <input id="horaInicio" type="time">

    <label>KM inicial</label>
    <input id="kmInicial" type="number">

    <label>Hor√°rio final</label>
    <input id="horaFim" type="time">

    <label>KM final</label>
    <input id="kmFinal" type="number">

    <div style="margin-top:12px; font-size:14px;">
      <strong>Total KM:</strong> <span id="totalKmDisplay">0 km</span><br>
      <strong>Espera:</strong> <span id="tempoEsperaDisplay">0</span><br>
      <strong>Viagem:</strong> <span id="tempoViagemDisplay">0</span>
    </div>

    <h3 style="margin-top:15px;">Financeiro</h3>

    <label>Valor total (R$)</label>
    <input id="valor" type="number" step="0.01">

    <label>Data da viagem</label>
    <input id="dataViagem" type="date">

    <button id="btnEmitirPdf">Emitir PDF</button>
    <button id="btnEnviarWhats" style="background:#128c7e;">Enviar WhatsApp</button>
  </section>


  <!-- ======================
       ABA HIST√ìRICO
  ========================= -->
  <section id="abaHistorico" class="card" style="display:none;">
    <h3>Hist√≥rico</h3>
    <div id="listaRecibos"></div>
  </section>
</div> <!-- ./container -->

<!-- MENU INFERIOR IGUAL AS OUTRAS P√ÅGINAS -->
<div class="tabbar">
  <a href="index.html">üè†<small>Home</small></a>
  <a href="entradas.html">üíµ<small>Caixa</small></a>
  <button class="action-btn" onclick="location.href='calculadora.html'">+</button>
  <a href="resumo.html">üìä<small>Resumo</small></a>
  <a href="perfil.html">üë§<small>Perfil</small></a>
</div>

<script src="planos.js"></script>

<script>
/* ===============================
   BLOQUEIO POR PLANO (FREEMIUM)
================================= */
(function(){
  let p = 'free';
  try{
    if(typeof getPlano === 'function'){
      p = getPlano() || localStorage.getItem('planoAtual') || 'free';
    }else{
      p = localStorage.getItem('planoAtual') || 'free';
    }
  }catch(e){
    p = localStorage.getItem('planoAtual') || 'free';
  }
  p = (p || 'free').toLowerCase();

  if(p === 'freemium' || p === 'free'){
    alert("A p√°gina Recibo Empresa n√£o est√° dispon√≠vel no plano Freemium.");
    window.location.href = "planos.html";
  }
})();

/* ===============================
   HELPERS / STORAGE
================================= */
const $ = id => document.getElementById(id);

const RECIBOS_KEY  = "recibosViagemEmpresaRF";
const PERFIL_KEY   = "perfilReciboEmpresaRF";

function load(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : null;
  }catch(e){
    return null;
  }
}
function save(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function formatDateBr(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  if(isNaN(d)) return iso;
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function timeToMin(str){
  if(!str) return null;
  const [h,m] = str.split(":").map(Number);
  if(isNaN(h) || isNaN(m)) return null;
  return h*60 + m;
}
function formatMin(min){
  if(!min || min <= 0) return "0 min";
  const h = Math.floor(min/60);
  const m = min % 60;
  let txt = "";
  if(h>0) txt += h + "h";
  if(h>0 && m>0) txt += " ";
  if(m>0) txt += m + "min";
  return txt;
}

/* ===============================
   TEMA (ajustado para body.dark/body.light)
================================= */
function applyTheme(theme){
  const body = document.body;
  const btn  = $("toggleTheme");

  body.classList.remove("dark","light");

  if(theme === "dark"){
    body.classList.add("dark");
    localStorage.setItem("theme","dark");
    if(btn) btn.innerText = "‚òÄÔ∏è";
  } else {
    body.classList.add("light");
    localStorage.setItem("theme","light");
    if(btn) btn.innerText = "üåô";
  }
}

(function initTheme(){
  const saved = localStorage.getItem("theme") || "light";
  applyTheme(saved);
})();

/* ===============================
   ABAS
================================= */
function setAba(nome){
  const map = {
    cadastro: "abaCadastro",
    emitir: "abaEmitir",
    historico: "abaHistorico"
  };

  ["cadastro","emitir","historico"].forEach(tabName=>{
    const tabEl = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    const secId = map[tabName];
    const secEl = $(secId);

    if(tabEl) tabEl.classList.toggle("active", tabName === nome);
    if(secEl) secEl.style.display = (tabName === nome ? "block" : "none");
  });
}

/* ===============================
   PERFIL (CADASTRO)
================================= */
function preencherPerfil(){
  const p = load(PERFIL_KEY) || {};
  const campos = ["empresa","cnpj","motorista","cpf","marca","modelo","placa","cor"];
  campos.forEach(id=>{
    const el = $(id);
    if(el && p[id] != null) el.value = p[id];
  });
}

function salvarPerfil(){
  const data = {};
  ["empresa","cnpj","motorista","cpf","marca","modelo","placa","cor"].forEach(id=>{
    data[id] = ($(id)?.value || "").trim();
  });
  save(PERFIL_KEY, data);
  alert("Dados salvos com sucesso!");
}

const btnSalvarCadastro = $("btnSalvarCadastro");
if(btnSalvarCadastro){
  btnSalvarCadastro.addEventListener("click", salvarPerfil);
}

/* ===============================
   FUNCION√ÅRIOS
================================= */
const funcionariosContainer = $("funcionariosContainer");

function criarBlocoFuncionario(indice){
  const div = document.createElement("div");
  div.className = "funcionario-block";
  div.innerHTML = `
    <div class="func-label" style="font-weight:700;margin-bottom:8px;">
      Funcion√°rio ${indice}
    </div>
    <label>Nome</label>
    <input type="text" data-field="nome">
    <label>Empresa</label>
    <input type="text" data-field="empresa">
    <label>Local de embarque</label>
    <input type="text" data-field="local">
    <label>Hor√°rio de embarque</label>
    <input type="time" data-field="hora">
  `;
  return div;
}

function atualizarIndicesFuncionarios(){
  if(!funcionariosContainer) return;
  const blocks = funcionariosContainer.querySelectorAll(".funcionario-block");
  blocks.forEach((b,i)=>{
    const lbl = b.querySelector(".func-label");
    if(lbl) lbl.textContent = "Funcion√°rio " + (i+1);
  });
}

function adicionarFuncionario(){
  if(!funcionariosContainer) return;
  const qtd = funcionariosContainer.querySelectorAll(".funcionario-block").length;
  funcionariosContainer.appendChild(criarBlocoFuncionario(qtd+1));
  atualizarIndicesFuncionarios();
}

function removerFuncionario(){
  if(!funcionariosContainer) return;
  const blocks = funcionariosContainer.querySelectorAll(".funcionario-block");
  if(blocks.length > 1){
    blocks[blocks.length-1].remove();
    atualizarIndicesFuncionarios();
  }
}

const btnAddFuncionario    = $("btnAddFuncionario");
const btnRemoveFuncionario = $("btnRemoveFuncionario");

if(btnAddFuncionario)    btnAddFuncionario.addEventListener("click", adicionarFuncionario);
if(btnRemoveFuncionario) btnRemoveFuncionario.addEventListener("click", removerFuncionario);

// Garante 1 funcion√°rio inicial
if(funcionariosContainer && !funcionariosContainer.querySelector(".funcionario-block")){
  adicionarFuncionario();
}

/* ===============================
   LEITURA DOS CAMPOS
================================= */
function readDados(){
  const d = {
    empresaDestino:     $("empresaDestino")?.value || "",
    empresaResponsavel: $("empresaResponsavel")?.value || "",
    solicitante:        $("solicitante")?.value || "",
    horaChegada:        $("horaChegada")?.value || "",
    descricao:          $("descricao")?.value || "",
    horaInicio:         $("horaInicio")?.value || "",
    kmInicial:          $("kmInicial")?.value || "",
    horaFim:            $("horaFim")?.value || "",
    kmFinal:            $("kmFinal")?.value || "",
    valor:              $("valor")?.value || "",
    dataViagem:         $("dataViagem")?.value || "",
    funcionarios: []
  };

  document.querySelectorAll(".funcionario-block").forEach(block=>{
    const get = campo => block.querySelector(`[data-field="${campo}"]`)?.value || "";
    d.funcionarios.push({
      nome:    get("nome"),
      empresa: get("empresa"),
      local:   get("local"),
      hora:    get("hora")
    });
  });

  return d;
}

/* ===============================
   C√ÅLCULOS KM / TEMPO
================================= */
function compute(d){
  const ini = timeToMin(d.horaInicio);
  const fim = timeToMin(d.horaFim);
  const chg = timeToMin(d.horaChegada);

  let tempoViagemMin = 0;
  if(ini != null && fim != null){
    let diff = fim - ini;
    if(diff < 0) diff += 1440;
    tempoViagemMin = diff;
  }

  let tempoEsperaMin = 0;
  if(ini != null && chg != null){
    let diff = ini - chg;
    if(diff < 0) diff += 1440;
    tempoEsperaMin = diff;
  }

  const ki = parseFloat(d.kmInicial);
  const kf = parseFloat(d.kmFinal);
  let totalKm = null;
  if(!isNaN(ki) && !isNaN(kf)){
    totalKm = Math.max(0, kf - ki);
  }

  return {
    tempoViagemMin,
    tempoViagemStr: formatMin(tempoViagemMin),
    tempoEsperaMin,
    tempoEsperaStr: formatMin(tempoEsperaMin),
    totalKm
  };
}

function updateUI(){
  const dados = readDados();
  const res   = compute(dados);

  const elViagem  = $("tempoViagemDisplay");
  const elEspera  = $("tempoEsperaDisplay");
  const elTotalKm = $("totalKmDisplay");

  if(elViagem)  elViagem.textContent  = res.tempoViagemStr;
  if(elEspera)  elEspera.textContent  = res.tempoEsperaStr;
  if(elTotalKm) elTotalKm.textContent = (res.totalKm != null ? res.totalKm + " km" : "-");
}

// Eventos para recalcular
["horaChegada","horaInicio","horaFim","kmInicial","kmFinal"].forEach(id=>{
  const el = $(id);
  if(el) el.addEventListener("input", updateUI);
});

/* ===============================
   HIST√ìRICO
================================= */
function renderHistorico(){
  const box = $("listaRecibos");
  if(!box) return;

  const recs = load(RECIBOS_KEY) || [];
  if(!recs.length){
    box.innerHTML = "<div style='color:var(--muted);font-size:13px;'>Nenhum recibo emitido at√© o momento.</div>";
    return;
  }

  box.innerHTML = "";
  recs.forEach(r=>{
    const item = document.createElement("div");
    item.style.borderRadius = "10px";
    item.style.border = "1px solid #d7dce2";
    item.style.padding = "10px";
    item.style.marginBottom = "8px";
    item.style.fontSize = "13px";
    item.innerHTML = `
      <div style="font-weight:700;">${formatDateBr(r.dataViagem)}</div>
      <div>${r.empresaDestino || "-"}</div>
      <div style="opacity:.7;">Motorista: ${r.motorista || "-"}</div>
      <div style="opacity:.7;">Valor: ${r.valor ? "R$ " + Number(r.valor).toFixed(2).replace(".",",") : "-"}</div>
    `;
    box.appendChild(item);
  });
}

/* ===============================
   PDF (jsPDF)
================================= */
function gerarPdf(d, perfil, res){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("Biblioteca de PDF n√£o carregada.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 10;
  doc.setFontSize(14);
  doc.text("RECIBO DE VIAGEM - EMPRESA", 10, y); y += 8;

  doc.setFontSize(11);
  doc.text("Motorista: " + (perfil.motorista || ""), 10, y); y += 6;
  doc.text("Documento: " + (perfil.cpf || ""), 10, y); y += 6;
  doc.text("Ve√≠culo: " + (perfil.marca || "") + " " + (perfil.modelo || ""), 10, y); y += 6;
  doc.text("Placa: " + (perfil.placa || "") + " - Cor: " + (perfil.cor || ""), 10, y); y += 8;

  doc.text("Empresa destino: " + (d.empresaDestino || ""), 10, y); y += 6;
  doc.text("Empresa respons√°vel: " + (d.empresaResponsavel || ""), 10, y); y += 6;
  doc.text("Solicitante: " + (d.solicitante || ""), 10, y); y += 6;
  doc.text("Data: " + formatDateBr(d.dataViagem || new Date().toISOString().slice(0,10)), 10, y); y += 8;

  doc.text("Descri√ß√£o:", 10, y); y += 6;
  const splitDesc = doc.splitTextToSize(d.descricao || "", 180);
  doc.text(splitDesc, 10, y);
  y += splitDesc.length * 5 + 4;

  doc.text("Funcion√°rios:", 10, y); y += 6;
  (d.funcionarios || []).forEach((f,idx)=>{
    if(!(f.nome || "").trim()) return;
    const linha = `${idx+1}. ${f.nome} - ${f.empresa || ""} - ${f.local || ""} (${f.hora || ""})`;
    const lines = doc.splitTextToSize(linha, 180);
    doc.text(lines, 10, y);
    y += lines.length * 5;
    if(y > 270){
      doc.addPage();
      y = 10;
    }
  });

  y += 4;
  if(y > 260){ doc.addPage(); y = 10; }

  doc.text("KM inicial: " + (d.kmInicial || "-") + "   KM final: " + (d.kmFinal || "-") + "   Total: " + (res.totalKm != null ? res.totalKm + " km" : "-"), 10, y); y += 6;
  doc.text("Tempo de espera: " + res.tempoEsperaStr + "   Tempo de viagem: " + res.tempoViagemStr, 10, y); y += 10;

  const valorNumber = Number(d.valor || 0);
  doc.setFontSize(12);
  doc.text("Valor total: R$ " + valorNumber.toFixed(2).replace(".",","), 10, y); y += 20;

  doc.text("__________________________________", 10, y); y += 6;
  doc.text("Assinatura do respons√°vel", 10, y);

  doc.save("recibo_empresa.pdf");
}

/* ===============================
   EMITIR / WHATSAPP
================================= */
const btnEmitirPdf   = $("btnEmitirPdf");
const btnWhats       = $("btnEnviarWhats");

if(btnEmitirPdf){
  btnEmitirPdf.addEventListener("click", ()=>{
    let p = (localStorage.getItem("planoAtual") || "free").toLowerCase();
    try{
      if(typeof getPlano === "function"){
        p = (getPlano() || p).toLowerCase();
      }
    }catch(e){}
    if(p === "freemium" || p === "free"){
      alert("Fun√ß√£o de PDF n√£o dispon√≠vel no plano Freemium.");
      return;
    }

    const perfil = load(PERFIL_KEY) || {};
    const d      = readDados();
    const res    = compute(d);

    if(!(d.empresaDestino || "").trim()){
      alert("Informe a empresa destino.");
      return;
    }
    const temFunc = (d.funcionarios || []).some(f => (f.nome || "").trim());
    if(!temFunc){
      alert("Informe pelo menos um funcion√°rio.");
      return;
    }

    gerarPdf(d, perfil, res);

    const recs = load(RECIBOS_KEY) || [];
    recs.unshift({
      id: Date.now(),
      empresaDestino: d.empresaDestino,
      dataViagem: d.dataViagem || new Date().toISOString().slice(0,10),
      valor: d.valor || "",
      motorista: perfil.motorista || ""
    });
    save(RECIBOS_KEY, recs);
    renderHistorico();
    setAba("historico");
  });
}

if(btnWhats){
  btnWhats.addEventListener("click", ()=>{
    let p = (localStorage.getItem("planoAtual") || "free").toLowerCase();
    try{
      if(typeof getPlano === "function"){
        p = (getPlano() || p).toLowerCase();
      }
    }catch(e){}
    if(p === "freemium" || p === "free"){
      alert("Envio por WhatsApp n√£o dispon√≠vel no plano Freemium.");
      return;
    }

    const perfil = load(PERFIL_KEY) || {};
    const d      = readDados();
    const res    = compute(d);

    const dataStr = formatDateBr(d.dataViagem || new Date().toISOString().slice(0,10));
    const valorNumber = Number(d.valor || 0);

    let msg = `RECIBO EMPRESA%0A`;
    msg += `Destino: ${d.empresaDestino || "-"}%0A`;
    msg += `Data: ${dataStr}%0A`;
    msg += `Motorista: ${perfil.motorista || "-"}%0A`;
    msg += `Total KM: ${res.totalKm != null ? res.totalKm + " km" : "-"}%0A`;
    msg += `Valor: R$ ${valorNumber.toFixed(2).replace(".",",")}%0A%0A`;
    msg += `Funcion√°rios:%0A`;
    (d.funcionarios || []).forEach((f,i)=>{
      if(!(f.nome || "").trim()) return;
      msg += `${i+1}. ${f.nome} - ${f.empresa || ""} - ${f.local || ""} (${f.hora || ""})%0A`;
    });

    window.open("https://wa.me/?text=" + msg, "_blank");
  });
}

/* ===============================
   BOOT INICIAL
================================= */
(function boot(){
  preencherPerfil();
  updateUI();
  renderHistorico();
  // Come√ßar direto na aba Emitir (rotina)
  setAba("emitir");
})();
</script>

<script>
// Drawer
function toggleDrawer(){
  const dr = document.getElementById('drawer');
  dr.classList.toggle('open');
}

// Theme toggle usando applyTheme e body.dark/light
function toggleTheme(){
  const isDark = document.body.classList.contains("dark");
  const newTheme = isDark ? "light" : "dark";
  applyTheme(newTheme);
}

// Tabs pelo id (garantia)
document.getElementById("tabCadastro").addEventListener("click", ()=>setAba("cadastro"));
document.getElementById("tabEmitir").addEventListener("click",   ()=>setAba("emitir"));
document.getElementById("tabHistorico").addEventListener("click",()=>setAba("historico"));
</script>

</body>
</html>
