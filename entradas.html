<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caixa - RF Driver</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === ESTILO ORIGINAL PRESERVADO === */
:root{
  --gold:#f5c542; --bg:#0d0d0d; --text:#f4f4f4;
  --card:#161616; --border:#242424;
  --green:#1DB954; --red:#ff3b30;
}
body[data-theme="light"]{
  --bg:#f4f4f4; --text:#111; --card:#fff; --border:#ddd;
}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg);color:var(--text);padding:70px 16px 150px}
.header{text-align:center;margin-bottom:10px}
.header h1{margin:0;font-size:26px;color:var(--gold)}
.header small{opacity:.7}
.drawer-toggle,.theme-toggle{
  position:fixed;top:15px;font-size:22px;color:var(--gold);cursor:pointer;z-index:20
}
.drawer-toggle{left:15px}.theme-toggle{right:15px}
.drawer{
  position:fixed;top:0;left:-260px;width:260px;height:100%;
  background:var(--card);border-right:1px solid var(--border);
  padding-top:20px;transition:.3s;z-index:15
}
.drawer.open{left:0}
.drawer a{display:flex;gap:12px;padding:14px 20px;color:var(--text);fonte-size:15px;text-decoration:none;border-bottom:1px solid var(--border)}
.card,.summary{
  background:var(--card);border:1px solid var(--border);
  border-radius:14px;padding:16px;margin-bottom:15px
}
.summary-row{display:flex;justify-content:space-between;font-weight:600}
.tab-buttons{display:flex;gap:8px;margin-bottom:10px}
.tab-btn{
  flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);
  background:var(--card);color:var(--text);opacity:.6;font-weight:600
}
.tab-btn.active{opacity:1;border-color:var(--gold);color:var(--gold)}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
table{width:100%;border-collapse:collapse}
td{padding:10px;border-bottom:1px solid var(--border)}
.del{color:var(--red);cursor:pointer;font-weight:700}
.footer-action{position center:;bottom:90px;left:16px;right:16px}
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;background:var(--card);
  border-top:0px solid var(--border);display:flex;justify-content:space-around;padding:8px 0
}
.bottom-nav a{color:var(--text);font-size:15px;text-decoration:none}
.center-btn{
  background:var(--gold);color:#000;width:58px;height:58px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:24px;margin-top:-30px
}

.suporte-whatsapp{
  margin:16px;
  padding:10px 14px;
  background:#25d366;
  color:#fff;
  border-radius:999px;
  text-align:center;
  font-weight:600;
  text-decoration:none;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
</style>
</head>

<body>

<div class="drawer-toggle" onclick="drawer.classList.toggle('open')"><i class="fa fa-bars"></i></div>
<div class="theme-toggle" onclick="toggleTheme()"><i class="fa fa-moon"></i></div>

<nav class="drawer" id="drawer">
  <div class="close-btn" onclick="toggleDrawer()">
    <i class="fa fa-xmark"></i>
  </div>

  <a href="instalar-app.html"><i class="fa fa-download"></i> Como Instalar App</a>
  <a href="agendamentos.html"><i class="fa fa-calendar-check"></i> Agendamentos</a>
  <a href="entradas.html"><i class="fa fa-cash-register"></i> Livro Caixa</a>
  <a href="recibo.html"><i class="fa fa-receipt"></i> Emiss√£o de Recibo</a>
  <a href="resumo.html"><i class="fa fa-file"></i> Relat√≥rio Geral</a>
  <a href="calculadora.html"><i class="fa fa-calculator"></i> Calculadora de Viagens</a>
  <a href="manutencao.html"><i class="fa fa-tools"></i> Manuten√ß√£o</a>
  <a </a>
  <a class="suporte-whatsapp"
     href="https://wa.me/5581992716132?text=Ol%C3%A1%2C%20preciso%20de%20ajuda%20com%20o%20RF%20Driver."
     target="_blank">
    <i class="fa-brands fa-whatsapp"></i> Suporte WhatsApp
  </a>
</nav>

<div class="header">
  <h1>Livro Caixa</h1>
  <small>Gest√£o Financeira Di√°ria</small>
</div>

<div class="summary">
  <div class="summary-row"><span>Entradas</span><span id="resEntradas">R$ 0,00</span></div>
  <div class="summary-row"><span>Sa√≠das</span><span id="resSaidas">R$ 0,00</span></div>
  <div class="summary-row"><strong>Saldo</strong><strong id="resSaldo">R$ 0,00</strong></div>
  <canvas id="grafico" height="120"></canvas>
</div>

<div class="card">
  <button onclick="fecharCaixa()" style="
    background:var(--green);
    color:#000;
    font-weight:700;
    padding:14px;
    border-radius:12px;
    border:none;
    width:100%;
  ">
    üîí Fechar Caixa do Dia
  </button>
</div>

<div class="tab-buttons">
  <button class="tab-btn" data-tab="outras">Outras Entradas</button>
  <button class="tab-btn active" data-tab="corridas">Corridas</button>
  <button class="tab-btn" data-tab="saidas">Sa√≠das</button>
</div>

<div class="card tab" id="corridas">
  <select id="tipoCorrida">
    <option value="">Tipo de corrida</option>
    <option value="App">Corridas de Aplicativo</option>
    <option value="Entrega">Outros Aplicativos</option>
    <option value="Empresa">Empresa</option>
    <option value="Particular">Particular</option>
  </select>
  <select id="subTipo" style="display:none"></select>
  <input id="valorCorrida" type="number" placeholder="Valor (R$)">
  <table><tbody id="listaCorridas"></tbody></table>
</div>

<div class="card tab" id="outras" style="display:none">
  <input id="descOutra" placeholder="Descri√ß√£o">
  <input id="valorOutra" type="number" placeholder="Valor (R$)">
  <table><tbody id="listaOutras"></tbody></table>
</div>

<div class="card tab" id="saidas" style="display:none">
  <select id="tipoSaida">
    <option>Combust√≠vel</option><option>Alimenta√ß√£o</option><option>Ped√°gio</option><option>Outros</option>
  </select>
  <input id="valorSaida" type="number" placeholder="Valor (R$)">
  <table><tbody id="listaSaidas"></tbody></table>
</div>

<div class="footer-action">
  <button onclick="registrar()">Registrar</button>
</div>

<nav class="bottom-nav">
  <a href="planos.html"><i class="fa fa-crown"></i> </a>
  <a href="perfil.html"><i class="fa fa-user"></i> </a>
  <a href="carteira.html"><i class="fa fa-wallet"></i> </a>

  <!-- BOT√ÉO CENTRAL (DASHBOARD) -->
  <a href="index.html" class="center-btn">
    <i class="fa fa-house"></i>
  </a>

  <a href="registro-despesas.html"><i class="fa fa-file-signature"></i> </a>
  <a href="despesas-registradas.html"><i class="fa fa-list"></i> </a>
  <a href="acompanhamento-pagamentos.html"><i class="fa fa-clock"></i> </a>
</nav>

<script src="dataManager.js"></script>

<script>
/* ===== TEMA ===== */
(function(){document.body.dataset.theme=localStorage.getItem("tema")||"dark"})()
function toggleTheme(){
 const t=document.body.dataset.theme==="light"?"dark":"light"
 document.body.dataset.theme=t;localStorage.setItem("tema",t)
}

/* ===== DADOS ===== */
let dados=JSON.parse(localStorage.getItem("rf_caixa"))||{entradas:[],saidas:[]}

/* ===== GR√ÅFICO ===== */
const ctx=document.getElementById("grafico").getContext("2d")
const grafico=new Chart(ctx,{
 type:"bar",
 data:{labels:["Entradas","Sa√≠das"],datasets:[{data:[0,0],backgroundColor:["#1DB954","#ff3b30"]}]},
 options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
})

/* ===== SUBTIPOS ===== */
tipoCorrida.onchange=()=>{
 subTipo.style.display="none";subTipo.innerHTML=""
 let ops=[]
 if(tipoCorrida.value==="App") ops=["Uber","99","InDrive"]
 if(tipoCorrida.value==="Entrega") ops=["iFood","99Food","Uber Entregas","Rappi","Outros"]
 if(ops.length){subTipo.style.display="block";ops.forEach(o=>subTipo.innerHTML+=`<option>${o}</option>`)}
}

/* ===== ATUALIZA ===== */
function atualizar(){
 const ent=dados.entradas.reduce((s,i)=>s+i.valor,0)
 const sai=dados.saidas.reduce((s,i)=>s+i.valor,0)
 resEntradas.textContent=ent.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})
 resSaidas.textContent=sai.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})
 resSaldo.textContent=(ent-sai).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})
 grafico.data.datasets[0].data=[ent,sai];grafico.update()
 localStorage.setItem("rf_caixa",JSON.stringify(dados))
 localStorage.setItem("rf_caixa_total_entradas",ent)
 localStorage.setItem("rf_caixa_total_saidas",sai)
}

/* ===== REGISTRO / EXCLUS√ÉO ===== */
function registrar(){
 if(corridas.style.display!=="none"){
  dados.entradas.push({desc:tipoCorrida.value+(subTipo.value?" - "+subTipo.value:""),valor:+valorCorrida.value})
 }
 if(outras.style.display!=="none"){
  dados.entradas.push({desc:descOutra.value,valor:+valorOutra.value})
 }
 if(saidas.style.display!=="none"){
  dados.saidas.push({desc:tipoSaida.value,valor:+valorSaida.value})
 }
 render();atualizar()
}
function del(tipo,i){dados[tipo].splice(i,1);render();atualizar()}
function render(){
 listaCorridas.innerHTML=dados.entradas.map((e,i)=>`<tr><td>${e.desc}</td><td>${e.valor}</td><td class="del" onclick="del('entradas',${i})">‚úï</td></tr>`).join("")
 listaSaidas.innerHTML=dados.saidas.map((e,i)=>`<tr><td>${e.desc}</td><td>${e.valor}</td><td class="del" onclick="del('saidas',${i})">‚úï</td></tr>`).join("")
}
document.querySelectorAll(".tab-btn").forEach(b=>b.onclick=()=>{
 document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"))
 b.classList.add("active")
 document.querySelectorAll(".tab").forEach(t=>t.style.display="none")
 document.getElementById(b.dataset.tab).style.display="block"
})
render();atualizar()
</script>

<script>
function fecharCaixa() {
  const ent = dados.entradas.reduce((s,i)=>s + Number(i.valor || 0), 0);
  const sai = dados.saidas.reduce((s,i)=>s + Number(i.valor || 0), 0);
  const saldo = ent - sai;

  if (saldo <= 0) {
    alert("Saldo zerado ou negativo. Nada para transferir.");
    return;
  }

  if (!confirm(`Fechar o caixa e enviar R$ ${saldo.toFixed(2)} para a carteira?`)) {
    return;
  }

  const resp = DataManager.adicionarSaldoCarteira(saldo);

  if (!resp.ok) {
    alert(resp.msg || "Erro ao fechar caixa.");
    return;
  }

  // LIMPA DEFINITIVAMENTE O CAIXA
  localStorage.removeItem("rf_caixa");
  localStorage.removeItem("rf_caixa_total_entradas");
  localStorage.removeItem("rf_caixa_total_saidas");

  alert("Caixa fechado com sucesso. O caixa ser√° reiniciado.");

  // üî• GARANTE RESET TOTAL DO ESTADO
  location.reload();
}
</script>

</body>
</html>
