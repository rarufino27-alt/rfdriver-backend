<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard - RF Driver</title>

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  transition:.3s;
}

/* ===========================================
   PALETA (compat√≠vel com planos)
=========================================== */
:root{
  /* dourado escuro para light */
  --gold-light:#90731b;
  --gold-light2:#b08c2e;

  /* dourado para dark */
  --gold-dark:#d6b25f;
  --gold-dark2:#e8d08a;

  /* dark */
  --bg-dark:#0d0d0d;
  --text-dark:#f4f4f4;
  --card-dark:#161616;
  --panel-dark:#131313;
  --border-dark:#242424;

  /* light */
  --bg-light:#f7f7f7;
  --text-light:#222;
  --card-light:#ffffff;
  --panel-light:#ffffff;
  --border-light:#d6d6d6;
}

/* THEME */
body.dark{
  --bg:var(--bg-dark);
  --text:var(--text-dark);
  --card:var(--card-dark);
  --panel:var(--panel-dark);
  --border:var(--border-dark);
  --gold-main:var(--gold-dark);
  --gold-main2:var(--gold-dark2);
}
body.light{
  --bg:var(--bg-light);
  --text:var(--text-light);
  --card:var(--card-light);
  --panel:var(--panel-light);
  --border:var(--border-light);
  --gold-main:var(--gold-light);
  --gold-main2:var(--gold-light2);
}

/* gold */
.gold{ color:var(--gold-main); }
.gold2{ color:var(--gold-main2); }

/* ===========================================
   MENU LATERAL
=========================================== */
.drawer{
  position:fixed;
  top:0; left:-260px;
  width:260px; height:100%;
  background:var(--card);
  padding-top:70px;
  transition:left .3s;
  z-index:9999;
}
.drawer.open{ left:0; }
.drawer a{
  display:block;
  padding:15px 22px;
  border-bottom:1px solid var(--border);
  text-decoration:none;
  color:var(--text);
}

/* toggles */
.drawer-toggle{
  position:fixed; left:15px; top:15px;
  font-size:28px; cursor:pointer; z-index:10000;
}
.theme-toggle{
  position:fixed; right:15px; top:15px;
  font-size:24px; cursor:pointer; z-index:10000;
}

/* ===========================================
   MENU INFERIOR
=========================================== */
.tabbar{
  position:fixed; bottom:0; left:0; right:0;
  height:70px; z-index:9990;
  background:var(--panel);
  border-top:1px solid var(--border);
  display:flex; justify-content:space-around; align-items:center;
}
.tabbar a{
  text-decoration:none;
  color:var(--text);
  text-align:center;
  font-size:20px;
  flex:1;
}
.tabbar small{ font-size:12px; display:block; }
.tabbar a.active{ color:var(--gold-main); }

/* bot√£o central */
.action-btn{
  background:linear-gradient(90deg,var(--gold-main),var(--gold-main2));
  width:58px; height:58px;
  border:none; border-radius:30px;
  color:#000; font-size:26px;
  display:flex; align-items:center; justify-content:center;
  margin-top:-35px;
  box-shadow:0 0 12px rgba(0,0,0,.5);
}

/* ===========================================
   CONTE√öDO
=========================================== */
.container{
  padding:20px;
  padding-top:80px;
  padding-bottom:110px;
}
h1{
  font-size:26px;
  margin-bottom:8px;
}

/* filtros */
.filters{
  display:flex;
  gap:8px;
  margin:12px 0;
  flex-wrap:wrap;
}
.filter{
  padding:8px 12px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:999px;
  font-size:12px;
  opacity:.7;
  cursor:pointer;
}
.filter.active{
  opacity:1;
  background:linear-gradient(90deg,var(--gold-main),var(--gold-main2));
  color:#000;
  border:none;
}

/* per√≠odo custom */
.period{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:10px;
}
.period input{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
}

.note{
  font-size:13px;
  opacity:.7;
  margin-bottom:10px;
}

/* KPI cards */
.kpi{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px 18px 16px;
  margin-bottom:14px;
}
.kpi .label{
  font-size:14px;
  opacity:.8;
}
.kpi .value{
  font-size:28px;
  font-weight:700;
  margin-top:4px;
}
.kpi.positivo{ border-left:4px solid #1DB954; }
.kpi.negativo{ border-left:4px solid #ff3b30; }

/* row cards */
.row{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
.small{
  flex:1;
  min-width:200px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
}
.small .title{
  font-size:13px;
  opacity:.75;
}
.small .value{
  font-size:22px;
  font-weight:700;
  margin-top:6px;
}
.small .gastos{ color:#ff3b30; }

/* ===========================================
   GR√ÅFICOS
=========================================== */
.chart-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px 14px 12px;
  margin-top:16px;
}
.chart-title{
  font-size:14px;
  font-weight:600;
  margin-bottom:4px;
}
.chart-legend{
  font-size:11px;
  opacity:.65;
  margin-top:6px;
}

/* gr√°fico de barras vertical */
.chart-bars{
  display:flex;
  align-items:flex-end;
  gap:6px;
  height:160px;
  margin-top:10px;
}
.bar{
  flex:1;
  min-width:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
}
.bar-value{
  font-size:10px;
  opacity:.8;
  margin-bottom:4px;
}
.bar-inner{
  width:100%;
  border-radius:8px 8px 4px 4px;
  background:linear-gradient(180deg,var(--gold-main2),var(--gold-main));
  height:10%;
  transition:height .4s ease;
}
.bar-label{
  font-size:10px;
  opacity:.7;
  margin-top:4px;
}

/* gr√°fico horizontal gastos x lucro */
.chart-bars-h{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.h-row{
  display:flex;
  align-items:center;
  gap:6px;
}
.h-label{
  font-size:11px;
  width:80px;
  opacity:.8;
}
.h-bar-wrap{
  flex:1;
  height:14px;
  border-radius:999px;
  background:rgba(0,0,0,0.10);
  overflow:hidden;
}
body.light .h-bar-wrap{
  background:rgba(0,0,0,0.06);
}
.h-bar-inner{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--gold-main),var(--gold-main2));
  transition:width .4s ease;
}
.h-bar-inner.gastos{
  background:linear-gradient(90deg,#ff7b7b,#ff3b30);
}
.h-bar-inner.lucroNeg{
  background:linear-gradient(90deg,#666,#999);
}
.h-value{
  font-size:11px;
  min-width:70px;
  text-align:right;
}

/* estado vazio de gr√°fico */
.chart-empty{
  font-size:12px;
  opacity:.7;
  margin-top:12px;
}

</style>

<link rel="manifest" href="/rf-drive-control/manifest.json">
<meta name="theme-color" content="#fbbf24">

<!-- iOS (Safari) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="RF Driver">
<link rel="apple-touch-icon" href="/rf-drive-control/icons/icon-192.png">

</head>

<body>

<!-- BOT√ïES SUPERIORES -->
<div class="drawer-toggle gold" onclick="toggleDrawer()">‚ò∞</div>
<div class="theme-toggle gold" onclick="toggleTheme()">üåì</div>

<!-- MENU LATERAL -->
<nav class="drawer" id="drawer">
  <a href="instalar-app.html">üì≤ como instalar seu app!</a>
  <a href="index.html">üè† Dashboard</a>
  <a href="entradas.html">üíµ Caixa</a>
  <a href="resumo.html">üìä Resumo</a>
  <a href="calculadora.html">üìü Calculadora</a>
  <a href="planos.html">üíé Planos</a>
  <a href="perfil.html">üë§ Perfil</a>
  <a href="recibo.html">üì† Emiss√£o de Recibo</a>
  <a href="manutencao.html">üõ† Manuten√ß√£o</a>
</nav>

<div class="container">
  <h1 class="gold">Dashboard</h1>
  <div class="note">Resumo financeiro r√°pido do seu desempenho.</div>

  <!-- FILTROS DE PER√çODO -->
  <div class="filters">
    <button class="filter active" id="btnHoje">Hoje</button>
    <button class="filter" id="btnSemana">Semana</button>
    <button class="filter" id="btnMes">M√™s</button>
    <button class="filter" id="btnPers">Per√≠odo</button>
  </div>

  <div class="period" id="rangePers" style="display:none">
    <input type="date" id="ini">
    <input type="date" id="fim">
    <button class="filter" id="applyPers">Aplicar</button>
  </div>

  <div class="note" id="periodNote">Mostrando dados de hoje</div>

  <!-- LUCRO -->
  <div id="cardLucro" class="kpi">
    <div class="label">Lucro Estimado</div>
    <div id="lucroValor" class="value">R$ 0,00</div>
  </div>

  <!-- CARDS GERAIS -->
  <div class="row">
    <div class="small">
      <div class="title">Gastos</div>
      <div id="gastos" class="value gastos">R$ 0,00</div>
    </div>
    <div class="small">
      <div class="title">Faturado</div>
      <div id="fat" class="value">R$ 0,00</div>
    </div>
  </div>

  <!-- GR√ÅFICO DE BARRAS: FATURAMENTO POR DIA -->
  <div class="chart-card">
    <div class="chart-title">Faturamento por dia</div>
    <div id="chartFaturamento" class="chart-bars"></div>
    <div class="chart-legend">Baseado nas entradas do per√≠odo selecionado.</div>
  </div>

  <!-- GR√ÅFICO HORIZONTAL: GASTOS x FATURAMENTO x LUCRO -->
  <div class="chart-card">
    <div class="chart-title">Gastos x Faturamento x Lucro</div>
    <div id="chartGastosLucro" class="chart-bars-h"></div>
    <div class="chart-legend">Comparativo simples para enxergar o equil√≠brio financeiro.</div>
  </div>

</div>

<!-- MENU INFERIOR -->
<div class="tabbar">
  <a class="active gold" href="index.html">üè†<small>Home</small></a>
  <a href="entradas.html">üíµ<small>Caixa</small></a>
  <button class="action-btn" onclick="location.href='calculadora.html'">+</button>
  <a href="resumo.html">üìä<small>Resumo</small></a>
  <a href="planos.html">üíé<small>Planos</small></a>
</div>

<script>
/* ============ MENU LATERAL ============ */
function toggleDrawer(){
  document.getElementById('drawer').classList.toggle('open');
}

/* ============ TEMA ============ */
function toggleTheme(){
  const b=document.body;
  const newTheme=b.classList.contains('dark')?'light':'dark';
  b.classList.remove('dark','light');
  b.classList.add(newTheme);
  localStorage.setItem('theme',newTheme);
}
(function(){
  const th=localStorage.getItem('theme')||'dark';
  document.body.classList.add(th);
})();

/* ============ PLANO E BLOQUEIO ============ */

function getPlano(){
  return (localStorage.getItem("planoAtivo") || "FREEMIUM").toUpperCase();
}

function validarAcessoDashboard(){
  const p = getPlano();

  // Trial sempre pode
  if(p === "TRIAL") return;

  // Planos pagos (novos nomes)
  if(["MENSAL","SEMESTRAL","VITALICIO"].includes(p)) return;

  // Freemium n√£o permite
  alert("O Dashboard √© liberado apenas em planos pagos.");
  location.href = "planos.html";
}

validarAcessoDashboard();

/* ============ STATE ============ */
let periodo='hoje';
let ini=null,fim=null;

function load(){
  return JSON.parse(localStorage.getItem('entradasSaidas')||'[]');
}
function norm(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate());}

/* regra de bloqueio por plano nos filtros */
function block(p){
  const pl = plano();
  if(p==='semana' && pl==='FREE'){
    alert('Semana dispon√≠vel a partir do B√°sico.');
    location.href='planos.html'; return true;
  }
  if((p==='mes' || p==='pers') && (pl==='FREE' || pl==='MENSAL')){
    alert('M√™s e Per√≠odo dispon√≠veis a partir do Premium.');
    location.href='planos.html'; return true;
  }
  return false;
}

/* filtro por per√≠odo */
function ok(r){
  const d = new Date(r.criadoEm);
  if(isNaN(d)) return true;
  const h = norm(new Date());
  const dn = norm(d);

  if(periodo==='hoje') return dn.getTime()===h.getTime();

  if(periodo==='semana'){
    const lim=new Date(h);
    lim.setDate(lim.getDate()-6);
    return dn>=lim && dn<=h;
  }

  if(periodo==='mes'){
    return d.getMonth()===h.getMonth() && d.getFullYear()===h.getFullYear();
  }

  if(periodo==='pers'){
    if(!ini || !fim) return true;
    const d0=norm(ini), d1=norm(fim);
    return dn>=d0 && dn<=d1;
  }
  return true;
}

/* ============ RENDER PRINCIPAL ============ */
function render(){
  const regs = load().filter(ok);
  let entr=0, said=0;

  regs.forEach(r=>{
    if(r.tipo==='entrada') entr += Number(r.valor || r.valorBruto || 0);
    else said += Number(r.valor || 0);
  });

  document.getElementById('fat').innerText = fmt(entr);
  document.getElementById('gastos').innerText = fmt(said);

  const lucro = entr - said;
  document.getElementById('lucroValor').innerText = fmt(lucro);

  const card = document.getElementById('cardLucro');
  card.classList.remove('positivo','negativo');
  card.classList.add(lucro>=0 ? 'positivo' : 'negativo');

  // ATUALIZA OS DOIS GR√ÅFICOS
  updateCharts(regs, entr, said, lucro);
}

function fmt(v){
  return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

/* ============ GR√ÅFICOS ============ */

// coordena os dois gr√°ficos
function updateCharts(regs, entr, said, lucro){
  renderChartFaturamento(regs);
  renderChartGastosLucro(entr, said, lucro);
}

/* gr√°fico de barras verticais: faturamento por dia */
function renderChartFaturamento(regs){
  const box = document.getElementById('chartFaturamento');
  if(!box) return;

  const map = {};

  regs.forEach(r=>{
    // detectar tipo de movimenta√ß√£o
    const tipo = (r.tipo || r.movimento || r.categoria || '').toLowerCase();
    if(tipo.indexOf('entrada')===-1) return;

    // detectar campo de data
    const rawDate = r.criadoEm || r.data || r.dataHora || r.dataMov || r.registro || null;
    const d = new Date(rawDate);
    if(isNaN(d)) return;

    const key = d.toISOString().slice(0,10); // yyyy-mm-dd
    map[key] = (map[key]||0) + Number(r.valor||r.valorBruto||0);
  });

  const entries = Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
  if(entries.length===0){
    box.innerHTML = '<div class="chart-empty">Sem dados de faturamento neste per√≠odo.</div>';
    return;
  }

  const max = Math.max(...entries.map(e=>e[1])) || 1;
  let html = '';

  entries.forEach(([dStr,val])=>{
    const d = new Date(dStr);
    const dia = String(d.getDate()).padStart(2,'0');
    const pct = Math.max(8,(val/max)*100);

    html += `
    <div class="bar">
      <div class="bar-value">${fmt(val)}</div>
      <div class="bar-inner" style="height:${pct}%"></div>
      <div class="bar-label">${dia}</div>
    </div>
    `;
  });

  box.innerHTML = html;
}

/* gr√°fico horizontal: gastos x faturamento x lucro */
function renderChartGastosLucro(entr, said, lucro){
  const box = document.getElementById('chartGastosLucro');
  if(!box) return;

  if(entr===0 && said===0){
    box.innerHTML = '<div class="chart-empty">Sem dados suficientes para compara√ß√£o.</div>';
    return;
  }

  const base = Math.max(entr, said, Math.abs(lucro)) || 1;

  function row(label, valor, extraClass){
    const pct = Math.max(6,(Math.abs(valor)/base)*100);
    const cls = extraClass ? ' '+extraClass : '';
    return `
      <div class="h-row">
        <div class="h-label">${label}</div>
        <div class="h-bar-wrap">
          <div class="h-bar-inner${cls}" style="width:${pct}%"></div>
        </div>
        <div class="h-value">${fmt(valor)}</div>
      </div>
    `;
  }

  const lucroClass = lucro<0 ? 'lucroNeg' : '';
  box.innerHTML =
    row('Faturado', entr, '') +
    row('Gastos', said, 'gastos') +
    row('Lucro', lucro, lucroClass);
}

/* ============ UI DOS FILTROS ============ */
document.getElementById('btnHoje').onclick = ()=>{
  periodo='hoje'; updateUI(); render();
};
document.getElementById('btnSemana').onclick = ()=>{
  if(block('semana')) return;
  periodo='semana'; updateUI(); render();
};
document.getElementById('btnMes').onclick = ()=>{
  if(block('mes')) return;
  periodo='mes'; updateUI(); render();
};
document.getElementById('btnPers').onclick = ()=>{
  if(block('pers')) return;
  periodo='pers'; updateUI(); render();
};

document.getElementById('applyPers').onclick = ()=>{
  const iniV = document.getElementById('ini').value;
  const fimV = document.getElementById('fim').value;
  ini = iniV ? new Date(iniV) : null;
  fim = fimV ? new Date(fimV) : null;
  if(!ini || !fim){ alert('Selecione as duas datas.'); return; }
  if(ini > fim){ alert('Data inicial maior que a final.'); return; }
  periodo='pers'; updateUI(); render();
};

function updateUI(){
  ['btnHoje','btnSemana','btnMes','btnPers'].forEach(id=>{
    document.getElementById(id).classList.remove('active');
  });
  if(periodo==='hoje') document.getElementById('btnHoje').classList.add('active');
  if(periodo==='semana') document.getElementById('btnSemana').classList.add('active');
  if(periodo==='mes') document.getElementById('btnMes').classList.add('active');
  if(periodo==='pers') document.getElementById('btnPers').classList.add('active');

  document.getElementById('rangePers').style.display = (periodo==='pers') ? 'flex':'none';

  const note = document.getElementById('periodNote');
  if(periodo==='hoje') note.innerText='Mostrando dados de hoje';
  if(periodo==='semana') note.innerText='√öltimos 7 dias';
  if(periodo==='mes') note.innerText='M√™s atual';
  if(periodo==='pers') note.innerText='Per√≠odo selecionado';
}

/* inicializa√ß√£o */
updateUI();
render();
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
      navigator.serviceWorker.register("service-worker.js")
      .then(function (reg) {
        console.log("Service Worker registrado:", reg.scope);
      })
      .catch(function (err) {
        console.log("Erro ao registrar o Service Worker:", err);
      });
  });
}
</script>

</body>
</html>
